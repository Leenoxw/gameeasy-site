---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import { gamesData } from '../data/games.js';

const allGames = [...gamesData];
// Extraction des catégories uniques (basé sur tes 15 genres harmonisés)
const categories = ["Tous", ...new Set(allGames.map(game => game.cat.split(' / ')[0]))];
---

<Layout title="Catalogue des Cracks - GAMEASY">
  <Header />
  
  <main class="catalogue-page">
    <div class="main-wrapper">
      
      <aside class="ads-side">
        <div class="ad-container">
          <div class="ad-label">PUBLICITÉ</div>
          <div class="ad-content"><i class="fas fa-ad"></i></div>
        </div>
      </aside>

      <div class="container">
        <header class="cat-header">
          <p class="subtitle">EXPLOREZ LE CATALOGUE</p>
          <h1>TOUS LES <span class="purple">CRACKS</span></h1>
          <p class="count">Nous avons actuellement <strong>{allGames.length}</strong> jeux disponibles.</p>
        </header>

        <div class="filter-container">
          <div class="filter-group">
            <span class="filter-label">Genre :</span>
            <div class="filter-options" id="categoryFilters">
              {categories.map(cat => (
                <button class="filter-btn" data-type="cat" data-value={cat.toLowerCase()}>{cat}</button>
              ))}
            </div>
          </div>

          <div class="filter-group">
            <span class="filter-label">Mode :</span>
            <div class="filter-options" id="modeFilters">
              <button class="filter-btn active-mode" data-type="mode" data-value="tous">Tous</button>
              <button class="filter-btn" data-type="mode" data-value="solo">Solo</button>
              <button class="filter-btn" data-type="mode" data-value="multi">Multi</button>
            </div>
          </div>

          <div class="search-bar">
            <i class="fas fa-search"></i>
            <input type="text" id="gameSearch" placeholder="Rechercher un titre (ex: GTA V, Elden Ring...)" />
          </div>
        </div>

        <div class="game-grid" id="gameGrid">
          {allGames.map(game => (
            <a href={`${game.id}`} 
               class="game-card" 
               data-title={game.title.toLowerCase()} 
               data-cat={game.cat.toLowerCase()}
               data-mode={game.mode.toLowerCase()}>
              <div class="card-inner">
                <div class="img-badges">
                  <span class="badge cat">{game.cat.split(' / ')[0]}</span>
                  <span class={`badge mode ${game.mode.toLowerCase().includes('multi') ? 'multi' : 'solo'}`}>
                    {game.mode}
                  </span>
                </div>
                <img src={game.image} alt={game.title} loading="lazy" />
                <div class="card-info">
                  <h3>{game.title}</h3>
                  <div class="card-footer">
                    <span class="status-ok"><i class="fas fa-check-circle"></i> DISPONIBLE</span>
                    <span class="view-more">VOIR <i class="fas fa-plus"></i></span>
                  </div>
                </div>
              </div>
            </a>
          ))}
        </div>

        <div class="pagination-wrapper">
          <button id="prevBtn" class="pg-btn disabled"><i class="fas fa-arrow-left"></i> Précédent</button>
          <div id="pageNumbers" class="page-numbers"></div>
          <button id="nextBtn" class="pg-btn">Suivant <i class="fas fa-arrow-right"></i></button>
        </div>

      </div>

      <aside class="ads-side">
        <div class="ad-container">
          <div class="ad-label">PUBLICITÉ</div>
          <div class="ad-content"><i class="fas fa-ad"></i></div>
        </div>
      </aside>

    </div>
  </main>
  <Footer />
</Layout>

<script>
  const searchInput = document.getElementById('gameSearch') as HTMLInputElement;
  const cards = document.querySelectorAll('.game-card');
  const catBtns = document.querySelectorAll('[data-type="cat"]');
  const modeBtns = document.querySelectorAll('[data-type="mode"]');
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');
  const pageNumbersContainer = document.getElementById('pageNumbers');

  let activeCat = 'tous';
  let activeMode = 'tous';
  let currentPage = 1;
  const gamesPerPage = 18; // Change ici pour afficher plus ou moins de jeux par page
  let filteredCards: Element[] = [];

  function applyPagination() {
    // 1. Filtrer les cartes selon les critères (Recherche, Cat, Mode)
    const search = searchInput.value.toLowerCase();
    filteredCards = Array.from(cards).filter(card => {
      const title = card.getAttribute('data-title') || '';
      const cat = card.getAttribute('data-cat') || '';
      const mode = card.getAttribute('data-mode') || '';

      const matchSearch = title.includes(search);
      const matchCat = activeCat === 'tous' || cat.includes(activeCat);
      const matchMode = activeMode === 'tous' || mode.includes(activeMode);

      return matchSearch && matchCat && matchMode;
    });

    // 2. Calculer les pages
    const totalPages = Math.ceil(filteredCards.length / gamesPerPage);
    if (currentPage > totalPages) currentPage = totalPages || 1;

    // 3. Afficher / Cacher les cartes
    const start = (currentPage - 1) * gamesPerPage;
    const end = start + gamesPerPage;

    cards.forEach(card => (card as HTMLElement).style.display = 'none'); // On cache tout
    filteredCards.slice(start, end).forEach(card => (card as HTMLElement).style.display = 'block'); // On montre la page

    // 4. Update UI boutons
    updatePaginationUI(totalPages);
  }

  function updatePaginationUI(totalPages: number) {
    if (pageNumbersContainer) {
        pageNumbersContainer.innerHTML = `Page <span>${currentPage}</span> sur ${totalPages || 1}`;
    }

    prevBtn?.classList.toggle('disabled', currentPage === 1);
    nextBtn?.classList.toggle('disabled', currentPage === totalPages || totalPages === 0);
  }

  // Events
  catBtns.forEach(btn => {
    // Initialiser le bouton "Tous" en actif
    if(btn.getAttribute('data-value') === 'tous') btn.classList.add('active-cat');

    btn.addEventListener('click', () => {
      catBtns.forEach(b => b.classList.remove('active-cat'));
      btn.classList.add('active-cat');
      activeCat = btn.getAttribute('data-value') || 'tous';
      currentPage = 1;
      applyPagination();
    });
  });

  modeBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      modeBtns.forEach(b => b.classList.remove('active-mode'));
      btn.classList.add('active-mode');
      activeMode = btn.getAttribute('data-value') || 'tous';
      currentPage = 1;
      applyPagination();
    });
  });

  searchInput?.addEventListener('input', () => {
    currentPage = 1;
    applyPagination();
  });

  prevBtn?.addEventListener('click', () => {
    if (currentPage > 1) {
      currentPage--;
      applyPagination();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
  });

  nextBtn?.addEventListener('click', () => {
    const totalPages = Math.ceil(filteredCards.length / gamesPerPage);
    if (currentPage < totalPages) {
      currentPage++;
      applyPagination();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
  });

  // Init
  applyPagination();
</script>

<style>
  /* --- TES STYLES EXISTANTS --- */
  .catalogue-page { padding: 120px 0 80px; background: #060612; min-height: 100vh; color: white; overflow-x: hidden; }
  .main-wrapper { display: flex; justify-content: center; gap: 30px; max-width: 1750px; margin: 0 auto; padding: 0 20px; }
  .container { flex: 1; max-width: 1200px; width: 100%; }
  .ads-side { flex: 0 0 160px; position: sticky; top: 100px; height: 600px; }
  .ad-container { width: 100%; height: 100%; background: rgba(255, 255, 255, 0.02); border: 1px solid rgba(138, 79, 255, 0.1); border-radius: 12px; display: flex; flex-direction: column; overflow: hidden; }
  .ad-label { background: rgba(138, 79, 255, 0.1); font-size: 10px; text-align: center; padding: 5px; color: #555; font-weight: 900; }
  .ad-content { flex: 1; display: flex; align-items: center; justify-content: center; color: #1a1a2e; font-size: 2rem; }
  .cat-header { text-align: center; margin-bottom: 40px; }
  .subtitle { color: #8a4fff; font-weight: 800; font-size: 0.8rem; letter-spacing: 3px; margin-bottom: 10px; }
  .cat-header h1 { font-size: 3.5rem; font-weight: 900; margin-bottom: 10px; line-height: 1; }
  .purple { color: #8a4fff; text-shadow: 0 0 20px rgba(138, 79, 255, 0.4); }
  .count { color: #666; font-size: 1rem; }
  .filter-container { background: #0c0c1d; padding: 25px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.05); margin-bottom: 40px; display: flex; flex-direction: column; gap: 20px; }
  .filter-group { display: flex; align-items: center; gap: 15px; }
  .filter-label { font-weight: 800; color: #444; text-transform: uppercase; font-size: 0.7rem; width: 60px; }
  .filter-options { display: flex; gap: 8px; flex-wrap: wrap; }
  .filter-btn { background: #16162d; border: 1px solid #252545; color: #777; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 0.85rem; transition: 0.2s; }
  .filter-btn:hover { border-color: #8a4fff; color: white; }
  .filter-btn.active-cat, .filter-btn.active-mode { background: #8a4fff; color: white; border-color: #8a4fff; box-shadow: 0 4px 12px rgba(138, 79, 255, 0.3); }
  .search-bar { background: #111125; border: 1px solid #252545; padding: 14px 20px; border-radius: 12px; display: flex; align-items: center; gap: 15px; }
  .search-bar input { background: transparent; border: none; color: white; outline: none; width: 100%; font-size: 1rem; }
  .search-bar i { color: #8a4fff; }
  .game-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 25px; min-height: 400px;}
  .game-card { text-decoration: none; transition: 0.3s ease-out; }
  .card-inner { background: #11111e; border-radius: 15px; overflow: hidden; border: 1px solid rgba(255,255,255,0.03); position: relative; }
  .game-card:hover { transform: translateY(-8px); }
  .game-card:hover .card-inner { border-color: #8a4fff; box-shadow: 0 15px 35px rgba(0,0,0,0.6); }
  .img-badges { position: absolute; top: 12px; left: 12px; display: flex; gap: 6px; z-index: 5; }
  .badge { padding: 4px 10px; border-radius: 5px; font-size: 0.65rem; font-weight: 900; color: white; text-transform: uppercase; }
  .badge.cat { background: rgba(138, 79, 255, 0.9); backdrop-filter: blur(4px); }
  .badge.mode.solo { background: #3498db; }
  .badge.mode.multi { background: #e67e22; }
  .card-inner img { width: 100%; aspect-ratio: 16/10; object-fit: cover; transition: 0.5s; }
  .game-card:hover img { transform: scale(1.18); }
  .card-info { padding: 20px; }
  .card-info h3 { color: white; font-size: 1.25rem; font-weight: 800; margin-bottom: 15px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .card-footer { display: flex; justify-content: space-between; align-items: center; }
  .status-ok { color: #00ff88; font-size: 0.7rem; font-weight: 800; letter-spacing: 1px; }
  .view-more { color: #8a4fff; font-size: 0.75rem; font-weight: 900; }

  /* --- NOUVEAU STYLE PAGINATION --- */
  .pagination-wrapper {
    display: flex;
    justify-content: center;
    align-items: center;
    margin-top: 50px;
    gap: 20px;
  }
  .pg-btn {
    background: #111125;
    border: 1px solid #252545;
    color: white;
    padding: 10px 20px;
    border-radius: 10px;
    cursor: pointer;
    font-weight: 700;
    transition: 0.3s;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .pg-btn:hover:not(.disabled) {
    background: #8a4fff;
    border-color: #8a4fff;
    box-shadow: 0 0 15px rgba(138, 79, 255, 0.3);
  }
  .pg-btn.disabled {
    opacity: 0.3;
    cursor: not-allowed;
  }
  .page-numbers {
    font-weight: 800;
    color: #444;
    text-transform: uppercase;
    font-size: 0.8rem;
  }
  .page-numbers span {
    color: #8a4fff;
  }

  @media (max-width: 1450px) { .ads-side { display: none; } .main-wrapper { display: block; } }
  @media (max-width: 768px) {
    .cat-header h1 { font-size: 2.2rem; }
    .filter-options { overflow-x: auto; width: 100vw; margin-left: -20px; padding: 0 20px 10px; flex-wrap: nowrap; }
  }
</style>