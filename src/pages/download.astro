---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import { gamesData } from '../data/games.js';
---

<Layout title="Préparation du téléchargement - GAMEASY">
  <Header />
  
  <main class="download-page">
    <div class="download-wrapper">
      
      <aside class="side-ad left-ad">
        <div class="ad-box vertical">
          <span class="ad-tag">PUBLICITÉ</span>
          <div class="iframe-container">
            <iframe data-aa='2425086' src='//acceptable.a-ads.com/2425086/?size=160x600' style='border:0; padding:0; width:160px; height:600px; overflow:hidden; background-color: transparent;'></iframe>
          </div>
        </div>
      </aside>

      <div class="center-content">
        
        <div class="horizontal-ad top-ad">
          <div class="ad-box banner">
            <span class="ad-tag">PUBLICITÉ</span>
            <div class="iframe-container">
              <iframe data-aa='2425088' src='//acceptable.a-ads.com/2425088/?size=728x90' style='border:0; padding:0; width:100%; height:90px; overflow:hidden; background-color: transparent;'></iframe>
            </div>
          </div>
        </div>

        <div class="dl-card" id="dlCard">
          <h1 id="gameTitle">Préparation de votre fichier...</h1>
          <p class="status-text">Votre téléchargement sera prêt dans :</p>
          <div class="timer" id="timer">15</div>
          
          <div class="inner-card-ad">
             <p class="sponsor-tag">SPONSORISÉ</p>
             <div class="ad-frame-wrapper">
                <iframe data-aa='2425090' src='//acceptable.a-ads.com/2425090/?size=Adaptive' style='border:0; padding:0; width:100%; height:100px; overflow:hidden; background-color: transparent;'></iframe>
             </div>
          </div>

          <div class="pre-button-ad">
             <div class="ad-frame-wrapper">
                <iframe data-aa='2425091' src='//acceptable.a-ads.com/2425091/?size=Adaptive' style='border:0; padding:0; width:100%; height:100px; overflow:hidden; background-color: transparent;'></iframe>
             </div>
          </div>

          <p class="warning">Ne fermez pas cette page pour éviter l'erreur de transfert.</p>
          
          <div id="buttonContainer" class="hidden">
            <a href="#" id="finalDownloadBtn" class="final-btn">
              <i class="fas fa-file-download"></i> CLIQUEZ ICI POUR TÉLÉCHARGER
            </a>
          </div>
        </div>

        <div class="horizontal-ad bottom-ad">
          <div class="ad-box banner">
            <span class="ad-tag">PUBLICITÉ</span>
            <div class="iframe-container">
              <iframe data-aa='2425089' src='//acceptable.a-ads.com/2425089/?size=728x90' style='border:0; padding:0; width:100%; height:90px; overflow:hidden; background-color: transparent;'></iframe>
            </div>
          </div>
        </div>
      </div>

      <aside class="side-ad right-ad">
        <div class="ad-box vertical">
          <span class="ad-tag">PUBLICITÉ</span>
          <div class="iframe-container">
            <iframe data-aa='2425087' src='//acceptable.a-ads.com/2425087/?size=160x600' style='border:0; padding:0; width:160px; height:600px; overflow:hidden; background-color: transparent;'></iframe>
          </div>
        </div>
      </aside>

    </div>
  </main>

  <Footer />

  <script>
    import { gamesData } from '../data/games.js';

    const params = new URLSearchParams(window.location.search);
    const gameId = params.get('id');
    const game = gamesData.find(g => g.id === gameId);

    const timerDisplay = document.getElementById('timer');
    const buttonContainer = document.getElementById('buttonContainer');
    const finalDownloadBtn = document.getElementById('finalDownloadBtn');
    const gameTitleDisplay = document.getElementById('gameTitle');

    if (game) {
      if(gameTitleDisplay) gameTitleDisplay.innerText = `Téléchargement de : ${game.title}`;
      if(finalDownloadBtn) (finalDownloadBtn as HTMLAnchorElement).href = game.dl;
      
      let timeLeft = 15;
      const countdown = setInterval(() => {
        timeLeft--;
        if(timerDisplay) timerDisplay.innerText = timeLeft.toString();

        if (timeLeft <= 0) {
          clearInterval(countdown);
          if(timerDisplay) timerDisplay.style.display = 'none';
          buttonContainer?.classList.remove('hidden');
        }
      }, 1000);
    } else {
      if(gameTitleDisplay) gameTitleDisplay.innerText = "Erreur : Jeu introuvable";
    }
  </script>
</Layout>

<style>
  .download-page {
    min-height: 100vh;
    background: #060612;
    padding: 120px 20px 60px;
    display: flex;
    justify-content: center;
  }

  .download-wrapper {
    display: flex;
    align-items: flex-start;
    gap: 40px;
    max-width: 1600px;
    width: 100%;
  }

  /* --- STYLES DES PUBS --- */
  .ad-box {
    background: #0c0c1d;
    border: 1px solid rgba(138, 79, 255, 0.1);
    border-radius: 12px;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }
  
  .ad-tag {
    font-size: 9px;
    color: #555;
    text-align: center;
    padding: 4px;
    background: rgba(0,0,0,0.5);
    font-weight: 900;
  }

  .iframe-container {
    display: flex;
    justify-content: center;
    align-items: center;
    background: transparent;
  }

  .ad-frame-wrapper {
    width: 100%;
    background: rgba(255,255,255,0.02);
    border-radius: 10px;
    overflow: hidden;
    display: flex;
    justify-content: center;
  }

  /* Pubs Verticales */
  .side-ad {
    flex: 0 0 160px;
    height: 600px;
    position: sticky;
    top: 100px;
  }

  /* Pubs Horizontales */
  .center-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 30px;
  }
  .horizontal-ad { width: 100%; max-width: 728px; }

  /* --- BLOC DE TÉLÉCHARGEMENT --- */
  .dl-card { 
    background: #0c0c1d; 
    padding: 40px; 
    border-radius: 30px; 
    border: 1px solid rgba(138, 79, 255, 0.2); 
    text-align: center; 
    width: 100%;
    max-width: 600px;
    box-shadow: 0 20px 50px rgba(0,0,0,0.5);
  }

  h1 { font-size: 1.8rem; color: white; margin: 20px 0; font-weight: 900; }
  .timer { font-size: 4rem; font-weight: 900; color: #8a4fff; margin: 15px 0; text-shadow: 0 0 20px rgba(138, 79, 255, 0.4); }
  .status-text { color: #888; font-size: 0.8rem; font-weight: 600; text-transform: uppercase; letter-spacing: 2px; }
  .sponsor-tag { color: #444; font-size: 10px; margin-bottom: 5px; font-weight: 800; }
  .warning { color: #555; font-size: 0.75rem; margin: 20px 0; }
  
  .inner-card-ad, .pre-button-ad { margin: 20px 0; }

  .final-btn { 
    display: flex; align-items: center; justify-content: center; gap: 10px;
    background: #8a4fff; color: white; text-decoration: none; padding: 18px 30px; 
    border-radius: 12px; font-weight: 900; font-size: 1.1rem; transition: 0.3s;
    animation: pulse 2s infinite;
  }
  .final-btn:hover { transform: scale(1.03); background: #9d6fff; }
  
  .hidden { display: none !important; }

  @media (max-width: 1200px) {
    .side-ad { display: none; }
  }

  @keyframes pulse {
    0% { box-shadow: 0 0 0 0 rgba(138, 79, 255, 0.6); }
    70% { box-shadow: 0 0 0 15px rgba(138, 79, 255, 0); }
    100% { box-shadow: 0 0 0 0 rgba(138, 79, 255, 0); }
  }
</style>