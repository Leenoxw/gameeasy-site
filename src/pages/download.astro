---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import { gamesData } from '../data/games.js';

// On ne met pas de getStaticPaths ici car c'est une page de rendu côté client (SSR ou statique avec recherche d'URL)
---

<Layout title="Préparation du téléchargement - GAMEASY">
  <Header />
  <main class="download-container">
    <div class="dl-card" id="dlCard">
      <div class="loader-circle"></div>
      <h1 id="gameTitle">Préparation de votre fichier...</h1>
      <p class="status-text">Votre téléchargement sera prêt dans :</p>
      <div class="timer" id="timer">15</div>
      <p class="warning">Ne fermez pas cette page pour éviter l'erreur de transfert.</p>
      
      <div id="buttonContainer" class="hidden">
        <a href="#" id="finalDownloadBtn" class="final-btn">
          <i class="fas fa-file-download"></i> CLIQUEZ ICI POUR TÉLÉCHARGER
        </a>
      </div>
    </div>
  </main>

  <script>
    import { gamesData } from '../data/games.js';

    // 1. Récupérer l'ID du jeu dans l'URL
    const params = new URLSearchParams(window.location.search);
    const gameId = params.get('id');
    const game = gamesData.find(g => g.id === gameId);

    const timerDisplay = document.getElementById('timer');
    const buttonContainer = document.getElementById('buttonContainer');
    const finalDownloadBtn = document.getElementById('finalDownloadBtn');
    const gameTitleDisplay = document.getElementById('gameTitle');

    if (game) {
      gameTitleDisplay.innerText = `Téléchargement de : ${game.title}`;
      (finalDownloadBtn as HTMLAnchorElement).href = game.dl;
      
      let timeLeft = 15;
      const countdown = setInterval(() => {
        timeLeft--;
        if(timerDisplay) timerDisplay.innerText = timeLeft.toString();

        if (timeLeft <= 0) {
          clearInterval(countdown);
          timerDisplay?.classList.add('hidden');
          buttonContainer?.classList.remove('hidden');
        }
      }, 1000);
    } else {
      if(gameTitleDisplay) gameTitleDisplay.innerText = "Erreur : Jeu introuvable";
    }
  </script>
</Layout>

<style>
  .download-container { 
    min-height: 100vh; display: flex; align-items: center; justify-content: center; 
    background: #060612; padding-top: 80px;
  }
  .dl-card { 
    background: #0c0c1d; padding: 60px; border-radius: 30px; 
    border: 1px solid rgba(138, 79, 255, 0.2); text-align: center; max-width: 600px; width: 90%;
  }
  h1 { font-size: 2rem; color: white; margin: 20px 0; font-weight: 900; }
  .timer { font-size: 5rem; font-weight: 900; color: #8a4fff; margin: 20px 0; text-shadow: 0 0 20px rgba(138, 79, 255, 0.4); }
  .status-text { color: #888; font-weight: 600; text-transform: uppercase; letter-spacing: 2px; }
  .warning { color: #555; font-size: 0.8rem; margin-top: 20px; }
  
  .final-btn { 
    display: flex; align-items: center; justify-content: center; gap: 10px;
    background: #8a4fff; color: white; text-decoration: none; padding: 20px 40px; 
    border-radius: 15px; font-weight: 900; font-size: 1.2rem; transition: 0.3s;
    animation: pulse 2s infinite;
  }
  .final-btn:hover { transform: scale(1.05); background: #9d6fff; }
  
  .hidden { display: none; }

  @keyframes pulse {
    0% { box-shadow: 0 0 0 0 rgba(138, 79, 255, 0.7); }
    70% { box-shadow: 0 0 0 15px rgba(138, 79, 255, 0); }
    100% { box-shadow: 0 0 0 0 rgba(138, 79, 255, 0); }
  }
</style>